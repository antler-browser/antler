# WebView Console Forwarding

## Overview

By default, Antler does **not** forward `console.log()`, `console.warn()`, `console.error()`, and `console.info()` messages from the WebView to React Native's console. This feature was disabled to optimize WebView loading performance.

### Why It Was Removed

Console forwarding adds overhead to WebView initialization and every console call:
- **Initial load:** ~20-30ms to set up lazy interceptors
- **Per-call overhead:** JSON serialization and postMessage for every console call
- **Impact:** Slows down mini app startup and debugging output

For most production use cases, you don't need to see mini app console logs in the React Native console.

## Alternative Debugging Methods

Instead of forwarding console logs to React Native, you can use these better debugging tools:

### 1. Chrome DevTools (Recommended)
Access the WebView console directly through Chrome:

**iOS:**
1. Open Safari â†’ Develop menu
2. Select your iOS device/simulator
3. Choose the WebView instance
4. Full DevTools available with console, network, elements, etc.

**Android:**
1. Open Chrome and navigate to `chrome://inspect`
2. Your device should appear under "Remote Target"
3. Click "Inspect" on the WebView
4. Full DevTools available

### 2. React Native Debugger
Use the standalone React Native Debugger app:
1. Install: `brew install --cask react-native-debugger`
2. Launch the app
3. Access WebView console in the DevTools panel

### 3. Flipper
Facebook's Flipper provides WebView debugging:
1. Install Flipper from https://fbflipper.com
2. Enable the WebView plugin
3. View console logs and inspect elements

## How to Re-enable Console Forwarding

If you need console logs forwarded to React Native for development, follow these steps:

### Step 1: Add placeholder to `lib/webview-injected.raw.js`

Find the line with `console.log('[IRL Browser] WebView API injected');` (around line 207) and add the placeholder **before** it:

```javascript
  };

  __CONSOLE_INTERCEPT_CODE__

  console.log('[IRL Browser] WebView API injected');
```

### Step 2: Update `lib/webview-injected.ts`

Add the `isDev` parameter back to the function signature:

```typescript
export function getInjectedJavaScript(
  webViewPublicKey: string,
  browserInfo: BrowserInfo,
  isDev: boolean = __DEV__  // Add this parameter
): string {
```

Then add the console intercept replacement logic:

```typescript
  // Replace placeholders in the pre-minified template
  let injectedCode = minifiedMainTemplate
    .replace('__WEBVIEW_PUBLIC_KEY__', webViewPublicKey)
    .replace('__BROWSER_INFO__', JSON.stringify(browserInfo))
    .replace('__CONSOLE_INTERCEPT_CODE__', isDev ? minifiedConsoleIntercept : ''); // Add this line

  return injectedCode;
}
```

### Step 3: Rebuild Minified Files

Run the minification script to regenerate the minified JavaScript:

```bash
yarn minify-webview
```

### Step 4: Restart Your App

Stop and restart your development server:

```bash
# Stop the current dev server (Ctrl+C)
yarn dev
```

### Step 5: Verify It's Working

In your mini app, test console forwarding:

```javascript
console.log('Hello from mini app!');
console.warn('Warning message');
console.error('Error message');
```

You should now see these messages prefixed with `[WebView console message]` in your React Native console.

## How It Works

When enabled, the console forwarding system immediately patches console methods on WebView load:

1. **On WebView load:** Wraps `console.log`, `console.warn`, `console.error`, and `console.info` to forward messages
2. **On console call:** Original method executes, then message is forwarded via `window.ReactNativeWebView.postMessage()`

### Implementation Details

The console interceptor (when enabled):
- Preserves original console behavior (calls still appear in WebView console)
- Wraps each console method with forwarding logic
- Serializes arguments to JSON (objects are stringified)
- Sends messages to React Native with type and method metadata
- Handles serialization errors gracefully (shows `[Object]` for non-serializable values)

### Performance Impact

When enabled, console forwarding adds:
- ~1-5ms per console call (JSON serialization + postMessage)

For mini apps with heavy console usage, this can noticeably impact performance.

## Code Reference

The console forwarding implementation can be found in:
- **Raw template:** `lib/webview-console-intercept.raw.js` - Console interceptor code (~30 lines)
- **Minified output:** `lib/webview-console-intercept.min.ts` (generated by `yarn minify-webview`)
- **Main template:** `lib/webview-injected.raw.js` - Where the `__CONSOLE_INTERCEPT_CODE__` placeholder should be added (line ~207)
- **Integration point:** `lib/webview-injected.ts` - TypeScript module that loads minified templates

## Best Practices

1. **Use native DevTools for debugging:** Chrome DevTools provides superior debugging experience with network inspection, breakpoints, and performance profiling
2. **Only enable when needed:** Console forwarding is useful for quick debugging but not necessary for most development
3. **Disable in production:** The `isDev` flag ensures console forwarding is only possible in development builds
4. **Consider performance:** Heavy console usage can slow down your mini app when forwarding is enabled

## Related Documentation

- [IRL Browser Standard](/docs/irl-browser-standard.md) - Full specification for mini app communication
- [WebView Security Architecture](/CLAUDE.md#webview--mini-app-integration) - ECDSA P-256 signing and XSS protection
